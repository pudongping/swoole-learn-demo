<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chat Client</title>
</head>
<body>
<script>

    window.onload = () => {

        var role = prompt("è¯·è¾“å…¥ä½ çš„è§’è‰² user æˆ–è€… admin");
        var input = document.getElementById("input");
        input.focus();
        var isClosed = false;
        var sendAdminId = 1;  // è¿™é‡Œå‡è®¾ç»™å®¢æœ id ä¸º 1 çš„äººå‘é€æ¶ˆæ¯

        // ç”¨æˆ·çš„ token
        let token = 'user_token_1';
        // ç”¨æˆ·ç±»å‹
        let type = 'user';
        // token å’Œ type å‚æ•°ä¸ºå¿…å¡«é¡¹
        let wsUrl = 'ws://127.0.0.1:5200?token=' + token + '&type=' + type;

        // åˆå§‹åŒ–å®¢æˆ·ç«¯å¥—æ¥å­—å¹¶å»ºç«‹è¿æ¥
        var socket = null;
        if ('WebSocket' in window) {
            socket = new WebSocket(wsUrl);
        } else if ('MozWebSocket' in window) {
            socket = new MozWebSocket(wsUrl);
        } else {
            console.error('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ websocket åè®®,å»ºè®®ä½¿ç”¨æ–°ç‰ˆè°·æ­Œã€ç«ç‹ç­‰æµè§ˆå™¨ï¼Œè¯·å‹¿ä½¿ç”¨ IE10 ä»¥ä¸‹æµè§ˆå™¨ï¼Œ360 æµè§ˆå™¨è¯·ä½¿ç”¨æé€Ÿæ¨¡å¼ï¼Œä¸è¦ä½¿ç”¨å…¼å®¹æ¨¡å¼ï¼');
            return false;
        }

        // è¿æ¥å»ºç«‹æ—¶è§¦å‘
        socket.onopen = event => {
            console.log("Connection open ...");
        };

        // è¿æ¥å‘ç”Ÿå‡ºé”™æ—¶è§¦å‘
        socket.onerror = event => {
            console.error('ws error ====> ', event);
        };

        input.onchange = () => {
            let msg = input.value;  // éœ€è¦å‘é€çš„æ¶ˆæ¯å†…å®¹

            let data = {
                event: 'service_chat',  // äº‹ä»¶åç§°ï¼šç”¨æˆ·å’Œå®¢æœç‚¹å¯¹ç‚¹å‘é€æ¶ˆæ¯
                receiver: {
                    id: sendAdminId,  // æ¥æ”¶è€…ç”¨æˆ·idï¼ˆè¿™é‡Œä¸ºå®¢æœ idï¼‰
                    type: 'admin',  // è¿™é‡Œæš‚ä¸”ä¸º adminï¼Œæ–¹ä¾¿ä»¥åæ‰©å±• user_to_userã€admin_to_admin æ•…ç•™
                },
                body: {
                    type: 'text',  // text-æ–‡å­—æ¶ˆæ¯ keywords-å…³é”®å­—æ¶ˆæ¯ img-å›¾ç‰‡æ¶ˆæ¯ video-è§†é¢‘æ¶ˆæ¯
                    content: msg,  // æ¶ˆæ¯å†…å®¹
                }
            };

            /*
            * å¦‚æœæ˜¯å‘é€ [keywords-å…³é”®å­—æ¶ˆæ¯] åˆ™ï¼Œbody.type ä¸º keywords ï¼Œä¸” body.content ä¸ºå…³é”®å­—çš„å†…å®¹
            * å¦‚æœæ˜¯å‘é€ [img-å›¾ç‰‡æ¶ˆæ¯] åˆ™ï¼Œbody.type ä¸º img ï¼Œä¸” body.content ä¸ºå›¾ç‰‡çš„ url åœ°å€
            * å¦‚æœæ˜¯å‘é€ [video-è§†é¢‘æ¶ˆæ¯] åˆ™ï¼Œbody.type ä¸º video ï¼Œä¸” body.content ä¸ºè§†é¢‘çš„ url åœ°å€
            * */

            // å°†è¾“å…¥æ¡†å˜æ›´ä¿¡æ¯é€šè¿‡ send æ–¹æ³•å‘é€åˆ° ws æœåŠ¡å™¨
            socket.send(JSON.stringify(data));
            input.value = "";
        };

        // æ¥æ”¶åˆ°æœåŠ¡ç«¯æ¨é€æ—¶æ‰§è¡Œ
        socket.onmessage = event => {

            let ret = JSON.parse(event.data);
            console.log('ws æœåŠ¡å™¨è¿”å›æ•°æ® =====> ', ret);
            let {code, msg: notice, data} = ret;
            let message = '====> ' + notice + ' => ';

            if (200 === code) {

                if (data.constructor === Object) {  // è¿”å› data ä¸ºå¯¹è±¡æ—¶ï¼Œåˆ™ä¸ºèŠå¤©æ¶ˆæ¯

                    let identity = '';
                    if (1 === data.send_user_type) {  // å‘é€è€…èº«ä»½,1:ç”¨æˆ·,2:åå°å®¢æœ
                        identity = 'right';  // ç”¨æˆ·æ¶ˆæ¯åœ¨å³è¾¹
                    } else if (2 === data.send_user_type) {
                        identity = 'left ';  // å®¢æœæ¶ˆæ¯åœ¨å·¦è¾¹
                    }

                    message += data.id + ' [ ' + identity + ' ' + data.send_time + ' ]ï¼Œ';
                    message += 'content => [ ' + data.content + ' ]ï¼Œ';
                    message += 'user  => [ ' + data.user.name + ' ]ï¼Œ';
                    message += 'admin => [ ' + data.admin.name + ' ]ï¼›';
                }
            } else {  // æ­¤æ—¶çš„ code ä¸º 400 ï¼ˆæœ‰å¼‚å¸¸ä¿¡æ¯æ—¶ï¼‰

            }

            if ('pong' === notice) {  // å¿ƒè·³åé¦ˆä¸å¤„ç†
                return false;
            }

            let node = document.createTextNode(message);
            let div = document.createElement("div");
            div.appendChild(node);
            document.body.insertBefore(div, input);
            input.scrollIntoView();
        };

        // è¿æ¥å…³é—­æ—¶è§¦å‘
        socket.onclose = event => {
            isClosed = true;
            console.log("Connection closed ...");
        };

        // å¿ƒè·³æ£€æµ‹
        (heartBeatCheck = () => {
            window.setInterval(() => {

                let data = {
                    event: 'heart_beat',  // äº‹ä»¶åç§°ï¼šå¿ƒè·³æ£€æµ‹
                };

                if (! isClosed) {
                    socket.send(JSON.stringify(data));
                    console.log('ğŸ’— pong! pong! pong!');
                }

            }, 5000);
        })();

    }
</script>
<input id="input" style="width: 100%;">
</body>
</html>
