<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chat Server</title>
</head>
<body>
<script>
    window.onload = function () {
        var role = prompt("è¯·è¾“å…¥ä½ çš„è§’è‰² user æˆ–è€… admin");
        var input = document.getElementById("input");
        input.focus();
        var sendUserId = 1;
        var maxReconnectTimes = 5;
        var maxCounter = 0;

        // å®¢æœ token
        let token = 'admin_token_1';
        // å®¢æœç±»å‹
        let type = 'admin';
        // token å’Œ type å‚æ•°ä¸ºå¿…å¡«é¡¹
        let wsUrl = 'ws://127.0.0.1:5200?token=' + token + '&type=' + type;

        var socket = null,  // ws è¿æ¥å¯¹è±¡
            lockReconnect = false,  // é¿å… ws é‡å¤è¿æ¥åŠ é”
            reconnectTimer = null,  // é‡è¿è®¡æ—¶å™¨
            reconnectTimeout = 4000;  // å¤šä¹…åé‡è¿ï¼Œå•ä½æ¯«ç§’ ms

        createWebSocket();

        // å»ºç«‹ ws è¿æ¥
        function createWebSocket() {
            try {

                if ('WebSocket' in window) {
                    socket = new WebSocket(wsUrl);
                } else if ('MozWebSocket' in window) {
                    socket = new MozWebSocket(wsUrl);
                } else {
                    console.error('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ websocket åè®®,å»ºè®®ä½¿ç”¨æ–°ç‰ˆè°·æ­Œã€ç«ç‹ç­‰æµè§ˆå™¨ï¼Œè¯·å‹¿ä½¿ç”¨ IE10 ä»¥ä¸‹æµè§ˆå™¨ï¼Œ360 æµè§ˆå™¨è¯·ä½¿ç”¨æé€Ÿæ¨¡å¼ï¼Œä¸è¦ä½¿ç”¨å…¼å®¹æ¨¡å¼ï¼');
                    return false;
                }

                init();

            } catch (e) {
                console.error('catch err => ', e);
                reconnect();  // è¿›è¡Œé‡è¿æ“ä½œ
            }
        };

        // å°è£… ws ç›‘å¬äº‹ä»¶
        function init() {

            // è¿æ¥å»ºç«‹æ—¶è§¦å‘
            socket.onopen = event => {
                console.log("Connection open ...");
                // å¿ƒè·³æ£€æµ‹é‡ç½®
                heartBeatCheck.reset().start();
            };

            // è¿æ¥å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘
            socket.onerror = event => {
                console.error('ws error ====> ', event);
                reconnect();  // è¿›è¡Œé‡è¿æ“ä½œ
            };

            // æ¥æ”¶åˆ°æœåŠ¡ç«¯æ¨é€æ—¶æ‰§è¡Œ
            socket.onmessage = event => {
                // å¿ƒè·³æ£€æµ‹é‡ç½®ï¼ˆå®¢æˆ·ç«¯èƒ½å¤Ÿæ”¶åˆ°æ¶ˆæ¯ï¼Œè¯æ˜å½“å‰è¿æ¥æ˜¯æ­£å¸¸çš„ï¼‰
                heartBeatCheck.reset().start();

                let ret = JSON.parse(event.data);
                console.log('ws è¿”å›å€¼ =====> ', ret);
                let {code, msg: notice, data} = ret;
                let message = '====> ' + notice + ' => ';

                if (200 === code) {
                    if (data.constructor === Object) {  // è¿”å› data ä¸ºå¯¹è±¡æ—¶ï¼Œåˆ™ä¸ºèŠå¤©æ¶ˆæ¯

                        let identity = '';
                        if (1 === data.send_user_type) {  // å‘é€è€…èº«ä»½,1:ç”¨æˆ·,2:åå°å®¢æœ
                            identity = 'left ';  // ç”¨æˆ·æ¶ˆæ¯åœ¨å·¦è¾¹
                        } else if (2 === data.send_user_type) {
                            identity = 'right';  // å®¢æœæ¶ˆæ¯åœ¨å³è¾¹
                        }

                        message += data.id + ' [ ' + identity + ' ' + data.send_time + ' ]ï¼Œ';
                        message += 'content => [ ' + data.content + ' ]ï¼Œ';
                        message += 'user  => [ ' + data.user.name + ' ]ï¼Œ';
                        message += 'admin => [ ' + data.admin.name + ' ]ï¼›';
                    }
                } else {  // æ­¤æ—¶çš„ code ä¸º 400 ï¼ˆæœ‰å¼‚å¸¸ä¿¡æ¯æ—¶ï¼‰

                }

                if ('pong' === notice) {  // å¿ƒè·³åé¦ˆä¸å¤„ç†
                    return false;
                }

                let node = document.createTextNode(message);
                let div = document.createElement("div");
                div.appendChild(node);
                document.body.insertBefore(div, input);
                input.scrollIntoView();
            };

            // è¿æ¥å…³é—­æ—¶è§¦å‘
            socket.onclose = event => {
                console.log("Connection closed ...");
                heartBeatCheck.reset();  // å…³é—­æ‰å¿ƒè·³æ£€æµ‹ç›¸å…³å®šæ—¶å™¨
                reconnect();  // è¿›è¡Œé‡è¿æ“ä½œ
            };

            // ç›‘å¬æµè§ˆå™¨çª—å£å…³é—­äº‹ä»¶ï¼Œå½“æµè§ˆå™¨çª—å£å…³é—­æ—¶ï¼Œä¸»åŠ¨å»å…³é—­ ws è¿æ¥ï¼Œé˜²æ­¢è¿æ¥è¿˜æ²¡æœ‰æ–­å¼€å°±å…³é—­çª—å£ï¼Œé€ æˆæœåŠ¡ç«¯å‡ºç°å¼‚å¸¸
            window.onbeforeunload = () => {
                socket.close();
            };

        };

        // é‡è¿
        function reconnect() {

            if (lockReconnect) return;  // å·²ç»é‡è¿ï¼Œåˆ™ä¸å†é‡è¿

            lockReconnect = true;  // é‡è¿æ—¶ï¼ŒåŠ é”ï¼Œé˜²æ­¢å¤šæ¬¡é‡è¿
            console.log('æ¬¡æ•°' , maxCounter);
            maxCounter++;
            if (maxCounter >= maxReconnectTimes) {
                console.log('åœæ­¢é‡è¿');
                return;
            }

            // æ²¡è¿ä¸Šä¼šä¸€ç›´é‡è¿ï¼Œè®¾ç½®å»¶è¿Ÿï¼Œä»¥é¿å…è¯·æ±‚è¿‡å¤š
            reconnectTimer && clearTimeout(reconnectTimer);
            reconnectTimer = setTimeout(() => {
                console.log('æ­£åœ¨é‡è¿ä¸­â€¦â€¦');
                lockReconnect = false;  // é‡Šæ”¾é‡è¿é”
                createWebSocket();  // é‡æ–°è¿æ¥
            }, reconnectTimeout);

        };

        // å¿ƒè·³æ£€æµ‹
        // å®ç°æ€è·¯ï¼š
        /*
         * æ¯éš”ä¸€æ®µå›ºå®šçš„æ—¶é—´ï¼Œå‘æœåŠ¡å™¨ç«¯å‘é€ä¸€ä¸ª ping æ•°æ®ï¼ˆæˆ–è€…éšä¾¿å‘é€ä¸€æ¡æµ‹è¯•æ•°æ®ï¼Œå‰åç«¯åè°ƒå¥½å°±è¡Œï¼‰ï¼Œ
         * å¦‚æœåœ¨æ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ª pong ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœå®¢æˆ·ç«¯é€šè¿‡ onmessage äº‹ä»¶èƒ½ç›‘å¬åˆ°çš„è¯ï¼Œè¯´æ˜è¯·æ±‚æ­£å¸¸ï¼Œ
         * è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš” 5 ç§’çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯ç½‘ç»œæ–­å¼€çš„æƒ…å†µä¸‹ï¼Œåœ¨æŒ‡å®šçš„æ—¶é—´å†…æœåŠ¡å™¨ç«¯å¹¶æ²¡æœ‰è¿”å›å¿ƒè·³å“åº”æ¶ˆæ¯ï¼Œå› æ­¤è¯æ˜æœåŠ¡å™¨ç«¯æ–­å¼€äº†ï¼Œ
         * å› æ­¤è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä½¿ç”¨ socket.close() æ–¹æ³•ä¸»åŠ¨å»å…³é—­å®¢æˆ·ç«¯ websocket è¿æ¥ï¼Œåœ¨ä¸€æ®µæ—¶é—´å(åœ¨ä¸åŒçš„æµè§ˆå™¨ä¸‹ï¼Œæ—¶é—´æ˜¯ä¸ä¸€æ ·çš„ï¼Œfirefox å“åº”æ›´å¿«)ï¼Œ
         * å¯ä»¥é€šè¿‡ onclose äº‹ä»¶ç›‘å¬åˆ°ã€‚å› æ­¤åœ¨ onclose äº‹ä»¶å†…ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ reconnect æ–¹æ³•è¿›è¡Œé‡è¿æ“ä½œã€‚
         * */
        var heartBeatCheck = {
            pingTimeout: 5000,  // å¿ƒè·³è¿æ¥æ—¶é—´
            serverTimeout: 5000,  // æœåŠ¡å™¨è¶…æ—¶æ—¶é—´
            heartTimer: null,  // å¿ƒè·³å®šæ—¶å™¨
            serverTimer: null,  // ws æœåŠ¡å™¨è¶…æ—¶å®šæ—¶å™¨
            reset: function () {  // é‡ç½®å¿ƒè·³å®šæ—¶å™¨å’Œ ws æœåŠ¡å™¨è¶…æ—¶å®šæ—¶å™¨
                clearTimeout(this.heartTimer);
                clearTimeout(this.serverTimer);
                return this;
            },
            start: function () {  // å¼€å§‹å‘é€å¿ƒè·³æ£€æµ‹
                var that = this;
                this.heartTimer && clearTimeout(this.heartTimer);
                this.serverTimer && clearTimeout(this.serverTimer);

                // å‘é€å¿ƒè·³
                this.heartTimer = setTimeout(() => {
                    let data = {
                        event: 'heart_beat',  // äº‹ä»¶åç§°ï¼šå¿ƒè·³æ£€æµ‹
                    };
                    socket.send(JSON.stringify(data));
                    console.log('ğŸ’— pong! pong! pong!');

                    // å¦‚æœç½‘ç»œæ–­å¼€çš„æƒ…å†µä¸‹ï¼Œåœ¨ that.serverTimeout æ—¶é—´å†…ï¼ŒæœåŠ¡å™¨ç«¯æ²¡æœ‰è¿”å›å¿ƒè·³å“åº”ï¼Œåˆ™è¯æ˜åç«¯ ws æœåŠ¡å·²ç»ä¸»åŠ¨æ–­å¼€
                    // äº¦åŠ serverTimer æ²¡æœ‰è¢«é‡ç½® ï¼ˆæœ‰æ¶ˆæ¯åé¦ˆæ—¶ï¼Œonmessage äº‹ä»¶å·²ç»å°† serverTimer å®šæ—¶å™¨ clearTimeoutï¼‰
                    that.serverTimer = setTimeout(() => {
                        console.log('å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­ ws è¿æ¥');
                        socket.close();  // ä¸»åŠ¨å»è§¦å‘å®¢æˆ·ç«¯ socket.onclose äº‹ä»¶ï¼Œè¿›è¡Œé‡è¿
                    }, that.serverTimeout);

                }, this.pingTimeout);

            },
        };


        input.onchange = () => {
            let msg = input.value;  // éœ€è¦å‘é€çš„æ¶ˆæ¯å†…å®¹

            let data = {
                event: 'service_chat',  // äº‹ä»¶åç§°ï¼šç”¨æˆ·å’Œå®¢æœç‚¹å¯¹ç‚¹å‘é€æ¶ˆæ¯
                receiver: {
                    id: sendUserId,  // æ¥æ”¶è€…ç”¨æˆ·idï¼ˆè¿™é‡Œä¸ºç”¨æˆ· idï¼‰
                    type: 'user',  // è¿™é‡Œæš‚ä¸”ä¸º userï¼Œæ–¹ä¾¿ä»¥åæ‰©å±• user_to_userã€admin_to_admin æ•…ç•™
                },
                body: {
                    type: 'text',  // text-æ–‡å­—æ¶ˆæ¯ keywords-å…³é”®å­—æ¶ˆæ¯ img-å›¾ç‰‡æ¶ˆæ¯ video-è§†é¢‘æ¶ˆæ¯
                    content: msg,  // æ¶ˆæ¯å†…å®¹
                }
            };

            /*
            * æ³¨æ„ï¼šå®¢æœç«¯æ˜¯æ²¡æœ‰å…³é”®å­—æ¶ˆæ¯çš„
            *
            *
            * å¦‚æœæ˜¯å‘é€ [keywords-å…³é”®å­—æ¶ˆæ¯] åˆ™ï¼Œbody.type ä¸º keywords ï¼Œåˆ‡ body.content ä¸ºå…³é”®å­—çš„å†…å®¹
            * å¦‚æœæ˜¯å‘é€ [img-å›¾ç‰‡æ¶ˆæ¯] åˆ™ï¼Œbody.type ä¸º img ï¼Œåˆ‡ body.content ä¸ºå›¾ç‰‡çš„ url åœ°å€
            * å¦‚æœæ˜¯å‘é€ [video-è§†é¢‘æ¶ˆæ¯] åˆ™ï¼Œbody.type ä¸º video ï¼Œåˆ‡ body.content ä¸ºè§†é¢‘çš„ url åœ°å€
            * */

            // å°†è¾“å…¥æ¡†å˜æ›´ä¿¡æ¯é€šè¿‡ send æ–¹æ³•å‘é€åˆ°æœåŠ¡å™¨
            socket.send(JSON.stringify(data));
            input.value = "";
        };

    }
</script>
<input id="input" style="width: 100%;">
</body>
</html>
